#!/bin/sh
# CONFIGURE SCRIPT FOR BUILD SYSTEM - v0.0
#
# Script to configure our build environment (sets some variables, lets us define
# some parameters about our build). Run this before any makefiles (trying to run
# them before configuring will hopefully throw an error, but even if it doesn't,
# the build WILL FAIL).
#
# Preferebly, we would do everything from the makefiles, but unfortunately that
# approach proved to be too cumbersome, so we have this small helper script.
#
#
# 2019 Diogo Gomes

scriptversion="0.0"

# ------------------------------------------------------------------------------
# Functions
# Some helper functions
# ------------------------------------------------------------------------------
function help {
    echo "Work in progress"
}

# ------------------------------------------------------------------------------
# Defaults
# These are the default values for our build variables
# ------------------------------------------------------------------------------

target=i686-elf # TODO: add targetarch

# Directories
rootsrcdir=$(pwd)
toolprefix=${HOME}/opt/
toolarchprefix=${target}-cross/bin/
toolarchdir=${toolprefix}${toolarchprefix}
ar=${toolarchdir}${target}-ar
as=${toolarchdir}${target}-as
cc=${toolarchdir}${target}-gcc
cxx=${toolarchdir}${target}-g++
isotool=${toolprefix}/grub-2/bin/grub-mkrescue
isochecktool=${toolprefix}/grub-2/bin/grub-file
sysroot=${rootsrcdir}/sysroot

# Target directories
prefix=/usr
execprefix=${prefix}
bootdir=/boot
libdir=${execprefix}/lib
includedir=${prefix}/include

# Tool flags
cflags="-O2 -ffreestanding"
cxxflags="-O2"
ldflags=
libs=

debugsym=true

for arg in "$@"; do
    case "$arg" in
    --toolprefix=*)
        toolprefix=`echo $arg | sed 's/--toolprefix=//'`
        ;;
    --toolarchprefix=*)
        toolarchprefix=`echo $arg | sed 's/--toolarchprefix=//'`
        ;;
    --toolarchdir=*)
        toolarchdir=`echo $arg | sed 's/--toolarchdir=//'`
        ;;
    --ar=*)
        ar=`echo $arg | sed 's/--ar=//'`
        ;;
    --as=*)
        as=`echo $arg | sed 's/--as=//'`
        ;;
    --cc=*)
        cc=`echo $arg | sed 's/--cc=//'`
        ;;
    --cxx=*)
        cxx=`echo $arg | sed 's/--cxx=//'`
        ;;
    --isotool=*)
        isotool=`echo $arg | sed 's/--isotool=//'`
        ;;
    --isochecktool=*)
        isochecktool=`echo $arg | sed 's/--isochecktool=//'`
        ;;
    --sysroot=*)
        sysroot=`echo $arg | sed 's/--sysroot=//'`
        ;;

    --prefix=*)
        prefix=`echo $arg | sed 's/--prefix=//'`
        ;;
    --execprefix=*)
        execprefix=`echo $arg | sed 's/--execprefix=//'`
        ;;
    --bootdir=*)
        bootdir=`echo $arg | sed 's/--bootdir=//'`
        ;;
    --libdir=*)
        libdir=`echo $arg | sed 's/--libdir=//'`
        ;;
    --includedir=*)
        includedir=`echo $arg | sed 's/--includedir=//'`
        ;;

    --cflags=*)
        cflags=`echo $arg | sed 's/--cflags=//'`
        ;;
    --cxxflags=*)
        cxxflags=`echo $arg | sed 's/--cxxflags=//'`
        ;;

    --enable-debug)
        debugsym=true;;
    --disable-debug)
        debugsym=false;;

    --help)
        echo 'usage: ./configure [options]'
        echo 'options:'
        echo '  --prefix=<path>: installation prefix'
        echo '  --enable-debug: include debug symbols'
        echo '  --disable-debug: do not include debug symbols'
        echo 'all invalid options are silently ignored'
        exit 0
        ;;
    esac
done

# ------------------------------------------------------------------------------
# Generating the build files
# ------------------------------------------------------------------------------

# Destination of config.mk
makefiles=`find . -name Makefile.in | sed 's/.in//'`
makeconfig=config/make/config.mk
outputconfig=config/make/output.mk.in

echo "generating ${makeconfig} ..."

# Header of the file
echo "# MAIN CONFIGURATION FILE FOR MAKEFILE" > ${makeconfig}
echo "#" >> ${makeconfig}
echo "# Autogenerated by configure version ${scriptversion} on $(date)" >> ${makeconfig}
echo "# CHANGE IT AT YOUR OWN RISK!" >> ${makeconfig}
echo "override SHELL:=/bin/sh" >> ${makeconfig}

# Writing configs to file
echo "TARGET:=${target}" >> ${makeconfig}
echo "ROOT_SRCDIR:=${rootsrcdir}" >> ${makeconfig}
echo "AR=${ar}" >> ${makeconfig}
echo "AS=${as}" >> ${makeconfig}
echo "CC=${cc}" >> ${makeconfig}
echo "CXX=${cxx}" >> ${makeconfig}
echo "ISOTOOL:=${isotool}" >> ${makeconfig}
echo "ISOCHECKTOOL:=${isochecktool}" >> ${makeconfig}
echo "SYSROOT:=${sysroot}" >> ${makeconfig}
echo "PREFIX?=${prefix}" >> ${makeconfig}
echo "EXEC_PREFIX?=${execprefix}" >> ${makeconfig}
echo "BOOTDIR?=${bootdir}" >> ${makeconfig}
echo "LIBDIR?=${libdir}" >> ${makeconfig}
echo "INCLUDEDIR?=${includedir}" >> ${makeconfig}
if $debugsym; then
    echo "CFLAGS:= ${cflags} -g" >> ${makeconfig}
    echo "CXXFLAGS:= ${cxxflags} -g" >> ${makeconfig}
else
    echo "CFLAGS:= ${cflags}" >> ${makeconfig}
    echo "CXXFLAGS:= ${cxxflags}" >> ${makeconfig}
fi
echo "LDFLAGS:= ${ldflags}" >> ${makeconfig}
echo "LIBS:= ${libs}" >> ${makeconfig}

echo "MADE_CONFIG:=true" >> ${makeconfig}

# Writing end of autofile comment
echo "# ------------------------------------------------------------------------------" >> ${makeconfig}
echo "# End of autoconfigured file" >> ${makeconfig}
echo "# ------------------------------------------------------------------------------" >> ${makeconfig}

# Writing the rest of the makeconfig
echo "" >> ${makeconfig}
cat ${makeconfig}.in >> ${makeconfig}
echo "" >> ${makeconfig}
cat ${outputconfig} >> ${makeconfig} # Some configurations for the make output

# Writing all makefiles
for name in ${makefiles}; do
    cat ${makeconfig} > $name
    echo "" >> $name
    cat ${name}.in >> $name
done

echo 'configuration complete, type make to build.'